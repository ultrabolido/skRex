<!DOCTYPE html>
<html>
<head>
<title>Rex: Routine at A2E6</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../skoolkit-dark.css" />
<link rel="stylesheet" type="text/css" href="../rex.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/scr/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="41691.html">A2DB</a>
</td>
<td class="up">Up: <a href="../maps/all.html#41702">Map</a></td>
<td class="next">
Next: <a href="41805.html">A34D</a>
</td>
</tr>
</table>
<div class="description">A2E6: Draws a windows in the display file</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Reads the text definition data format and draws the border and content of the windows. Used by the routines at <a href="38000.html">9470</a>, <a href="39395.html">99E3</a>, <a href="40296.html">9D68</a> and <a href="56857.html#57177">DF59</a>.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">IX</td>
<td class="register-desc">Address of the text definition data</td>
</tr>
<tr>
<td class="register">B</td>
<td class="register-desc">Number of lines of the windows</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="41702"></span>A2E6</td>
<td class="instruction">PUSH IX</td>
<td class="comment-1" rowspan="2">Save <span class="register">IX</span> and <span class="register">BC</span></td>
</tr>
<tr>
<td class="address-1"><span id="41704"></span>A2E8</td>
<td class="instruction">PUSH BC</td>
</tr>
<tr>
<td class="address-1"><span id="41705"></span>A2E9</td>
<td class="instruction">LD A,$01</td>
<td class="comment-1" rowspan="2">Initialise the width of the popup at <a href="41518.html">A22E</a></td>
</tr>
<tr>
<td class="address-1"><span id="41707"></span>A2EB</td>
<td class="instruction">LD ($A22E),A</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="41710"></span>
<div class="comments">
<div class="paragraph">
First compute the width of the windows based on the max length of all the lines of text plus 2 Special case: the first line of text computes a width of length of text plus 1
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="41710"></span>A2EE</td>
<td class="instruction">LD A,$01</td>
<td class="comment-1" rowspan="2">Initialise the temporal computed width of the windows at <a href="41516.html">A22C</a></td>
</tr>
<tr>
<td class="address-1"><span id="41712"></span>A2F0</td>
<td class="instruction">LD ($A22C),A</td>
</tr>
<tr>
<td class="address-1"><span id="41715"></span>A2F3</td>
<td class="instruction">LD DE,$0003</td>
<td class="comment-1" rowspan="2">In the first iteration, point <span class="register">IX</span> to the first character of the line. Subsequent iterations points to the vertical position</td>
</tr>
<tr>
<td class="address-1"><span id="41718"></span>A2F6</td>
<td class="instruction">ADD IX,DE</td>
</tr>
<tr>
<td class="address-2"><span id="41720"></span>A2F8</td>
<td class="instruction">LD A,(IX+$00)</td>
<td class="comment-1" rowspan="1">Pick up the character at <span class="register">IX</span></td>
</tr>
<tr>
<td class="address-1"><span id="41723"></span>A2FB</td>
<td class="instruction">OR A</td>
<td class="comment-1" rowspan="1">Is the character an end of marker ($00)?</td>
</tr>
<tr>
<td class="address-1"><span id="41724"></span>A2FC</td>
<td class="instruction">JP Z,$A308</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="41727"></span>A2FF</td>
<td class="instruction">LD HL,$A22C</td>
<td class="comment-1" rowspan="2">Increment the temporal computed width at <a href="41516.html">A22C</a></td>
</tr>
<tr>
<td class="address-1"><span id="41730"></span>A302</td>
<td class="instruction">INC (HL)</td>
</tr>
<tr>
<td class="address-1"><span id="41731"></span>A303</td>
<td class="instruction">INC IX</td>
<td class="comment-1" rowspan="1">Increment the address pointer to read the next character</td>
</tr>
<tr>
<td class="address-1"><span id="41733"></span>A305</td>
<td class="instruction">JP $A2F8</td>
<td class="comment-1" rowspan="1">Jump back and repeat the process</td>
</tr>
<tr>
<td class="address-2"><span id="41736"></span>A308</td>
<td class="instruction">LD A,($A22C)</td>
<td class="comment-1" rowspan="3">Compare the width computed in the last iteration with the max width previously saved</td>
</tr>
<tr>
<td class="address-1"><span id="41739"></span>A30B</td>
<td class="instruction">LD HL,$A22E</td>
</tr>
<tr>
<td class="address-1"><span id="41742"></span>A30E</td>
<td class="instruction">CP (HL)</td>
</tr>
<tr>
<td class="address-1"><span id="41743"></span>A30F</td>
<td class="instruction">JP C,$A315</td>
<td class="comment-1" rowspan="1">Jump if the max width is greater or equal than the current computed width</td>
</tr>
<tr>
<td class="address-1"><span id="41746"></span>A312</td>
<td class="instruction">LD ($A22E),A</td>
<td class="comment-1" rowspan="1">Update the max width of the windows at <a href="40859.html#41109">A095</a> with the new computed value</td>
</tr>
<tr>
<td class="address-2"><span id="41749"></span>A315</td>
<td class="instruction">DJNZ $A2EE</td>
<td class="comment-1" rowspan="1">Jump back while there are lines to process</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="41751"></span>
<div class="comments">
<div class="paragraph">
The next section of code obtain the position and color attributes of the windows
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="41751"></span>A317</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="2">Restore <span class="register">BC</span> and <span class="register">IX</span></td>
</tr>
<tr>
<td class="address-1"><span id="41752"></span>A318</td>
<td class="instruction">POP IX</td>
</tr>
<tr>
<td class="address-1"><span id="41754"></span>A31A</td>
<td class="instruction">PUSH IX</td>
<td class="comment-1" rowspan="2">Save <span class="register">BC</span> and <span class="register">IX</span></td>
</tr>
<tr>
<td class="address-1"><span id="41756"></span>A31C</td>
<td class="instruction">PUSH BC</td>
</tr>
<tr>
<td class="address-1"><span id="41757"></span>A31D</td>
<td class="instruction">LD A,B</td>
<td class="comment-1" rowspan="2">Is there only one line of text?</td>
</tr>
<tr>
<td class="address-1"><span id="41758"></span>A31E</td>
<td class="instruction">CP $01</td>
</tr>
<tr>
<td class="address-1"><span id="41760"></span>A320</td>
<td class="instruction">JP NZ,$A327</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="41763"></span>A323</td>
<td class="instruction">LD HL,$A22E</td>
<td class="comment-1" rowspan="2">Increment the width of the windows by one at <a href="41518.html">A22E</a>. This account for the special case described above</td>
</tr>
<tr>
<td class="address-1"><span id="41766"></span>A326</td>
<td class="instruction">INC (HL)</td>
</tr>
<tr>
<td class="address-2"><span id="41767"></span>A327</td>
<td class="instruction">LD A,(IX+$01)</td>
<td class="comment-1" rowspan="1">Pick up the horizontal position of the first line of text</td>
</tr>
<tr>
<td class="address-1"><span id="41770"></span>A32A</td>
<td class="instruction">SUB $03</td>
<td class="comment-1" rowspan="1">Substract 3 to obtain the horizontal position of the windows: one for the border and two for the left margin.</td>
</tr>
<tr>
<td class="address-1"><span id="41772"></span>A32C</td>
<td class="instruction">LD H,A</td>
<td class="comment-1" rowspan="1">Save the horizontal position of the windows at <span class="register">H</span></td>
</tr>
<tr>
<td class="address-1"><span id="41773"></span>A32D</td>
<td class="instruction">LD A,(IX+$02)</td>
<td class="comment-1" rowspan="1">Pick up the vertical position of the first line of text</td>
</tr>
<tr>
<td class="address-1"><span id="41776"></span>A330</td>
<td class="instruction">SRL A</td>
<td class="comment-1" rowspan="3">The position is defined in bits 7-3 so move this value to bits 4-0</td>
</tr>
<tr>
<td class="address-1"><span id="41778"></span>A332</td>
<td class="instruction">SRL A</td>
</tr>
<tr>
<td class="address-1"><span id="41780"></span>A334</td>
<td class="instruction">SRL A</td>
</tr>
<tr>
<td class="address-1"><span id="41782"></span>A336</td>
<td class="instruction">DEC A</td>
<td class="comment-1" rowspan="1">Decrement by one to account for the top border</td>
</tr>
<tr>
<td class="address-1"><span id="41783"></span>A337</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="1">Save the vertical position of the windows at <span class="register">L</span></td>
</tr>
<tr>
<td class="address-1"><span id="41784"></span>A338</td>
<td class="instruction">LD E,B</td>
<td class="comment-1" rowspan="1">Save the number of lines of the windows in register E</td>
</tr>
<tr>
<td class="address-1"><span id="41785"></span>A339</td>
<td class="instruction">LD A,($A22E)</td>
<td class="comment-1" rowspan="1">Pick up the width of the windows saved at <a href="41518.html">A22E</a></td>
</tr>
<tr>
<td class="address-1"><span id="41788"></span>A33C</td>
<td class="instruction">SUB $02</td>
<td class="comment-1" rowspan="1">Substract 2 for the borders</td>
</tr>
<tr>
<td class="address-1"><span id="41790"></span>A33E</td>
<td class="instruction">LD D,A</td>
<td class="comment-1" rowspan="1">Save the width of the windows (minus borders) at <span class="register">D</span></td>
</tr>
<tr>
<td class="address-1"><span id="41791"></span>A33F</td>
<td class="instruction">LD A,$47</td>
<td class="comment-1" rowspan="1">Save at <span class="register">A</span> the color attributes for the windows border</td>
</tr>
<tr>
<td class="address-1"><span id="41793"></span>A341</td>
<td class="instruction">LD C,$07</td>
<td class="comment-1" rowspan="1">Save at <span class="register">C</span> the color attributes for the windows body</td>
</tr>
<tr>
<td class="address-1"><span id="41795"></span>A343</td>
<td class="instruction">CALL <a href="47836.html">$BADC</a></td>
<td class="comment-1" rowspan="1">Draws the windows borders in the display file</td>
</tr>
<tr>
<td class="address-1"><span id="41798"></span>A346</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="2">Save <span class="register">BC</span> and <span class="register">IX</span></td>
</tr>
<tr>
<td class="address-1"><span id="41799"></span>A347</td>
<td class="instruction">POP IX</td>
</tr>
<tr>
<td class="address-1"><span id="41801"></span>A349</td>
<td class="instruction">CALL <a href="42119.html">$A487</a></td>
<td class="comment-1" rowspan="1">Print the text content of the windows in the display file</td>
</tr>
<tr>
<td class="address-1"><span id="41804"></span>A34C</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="41691.html">A2DB</a>
</td>
<td class="up">Up: <a href="../maps/all.html#41702">Map</a></td>
<td class="next">
Next: <a href="41805.html">A34D</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Rex (Side B) RAM disassembly 20211106</div>
<div class="copyright">&#169; 1988 Martech Games Ltd. &#169; 2021 Andreu Font.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.5.</div>
</footer>
</body>
</html>