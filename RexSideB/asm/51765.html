<!DOCTYPE html>
<html>
<head>
<title>Rex: Routine at CA35</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../skoolkit-dark.css" />
<link rel="stylesheet" type="text/css" href="../rex.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/scr/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="51683.html">C9E3</a>
</td>
<td class="up">Up: <a href="../maps/all.html#51765">Map</a></td>
<td class="next">
Next: <a href="51958.html">CAF6</a>
</td>
</tr>
</table>
<div class="description">CA35: Creates a new mobile enemy on room</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="38000.html">9470</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="51765"></span>CA35</td>
<td class="instruction">LD A,($A1DE)</td>
<td class="comment-1" rowspan="3">Return if generating train in current room</td>
</tr>
<tr>
<td class="address-1"><span id="51768"></span>CA38</td>
<td class="instruction">OR A</td>
</tr>
<tr>
<td class="address-1"><span id="51769"></span>CA39</td>
<td class="instruction">RET NZ</td>
</tr>
<tr>
<td class="address-1"><span id="51770"></span>CA3A</td>
<td class="instruction">LD A,($A1DC)</td>
<td class="comment-1" rowspan="3">Decrement enemy room enter counter</td>
</tr>
<tr>
<td class="address-1"><span id="51773"></span>CA3D</td>
<td class="instruction">DEC A</td>
</tr>
<tr>
<td class="address-1"><span id="51774"></span>CA3E</td>
<td class="instruction">LD ($A1DC),A</td>
</tr>
<tr>
<td class="address-1"><span id="51777"></span>CA41</td>
<td class="instruction">OR A</td>
<td class="comment-1" rowspan="2">Return if counter has not reached zero</td>
</tr>
<tr>
<td class="address-1"><span id="51778"></span>CA42</td>
<td class="instruction">RET NZ</td>
</tr>
<tr>
<td class="address-1"><span id="51779"></span>CA43</td>
<td class="instruction">LD A,($A1DD)</td>
<td class="comment-1" rowspan="2">Reset counter with the original value</td>
</tr>
<tr>
<td class="address-1"><span id="51782"></span>CA46</td>
<td class="instruction">LD ($A1DC),A</td>
</tr>
<tr>
<td class="address-1"><span id="51785"></span>CA49</td>
<td class="instruction">LD HL,$5E72</td>
<td class="comment-1" rowspan="1">Set <span class="register">HL</span> to the base address for enemy status into the enemy configuration table</td>
</tr>
<tr>
<td class="address-1"><span id="51788"></span>CA4C</td>
<td class="instruction">LD A,($A22B)</td>
<td class="comment-1" rowspan="2">Set <span class="register">B</span> to the max number of enemies for the room</td>
</tr>
<tr>
<td class="address-1"><span id="51791"></span>CA4F</td>
<td class="instruction">LD B,A</td>
</tr>
<tr>
<td class="address-2"><span id="51792"></span>CA50</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Check enemy status</td>
</tr>
<tr>
<td class="address-1"><span id="51793"></span>CA51</td>
<td class="instruction">OR A</td>
<td class="comment-1" rowspan="2">Jump forward if enemy dead/not visible</td>
</tr>
<tr>
<td class="address-1"><span id="51794"></span>CA52</td>
<td class="instruction">JP Z,$CA5C</td>
</tr>
<tr>
<td class="address-1"><span id="51797"></span>CA55</td>
<td class="instruction">LD DE,$001B</td>
<td class="comment-1" rowspan="2">Point to the next enemy configuration</td>
</tr>
<tr>
<td class="address-1"><span id="51800"></span>CA58</td>
<td class="instruction">ADD HL,DE</td>
</tr>
<tr>
<td class="address-1"><span id="51801"></span>CA59</td>
<td class="instruction">DJNZ $CA50</td>
<td class="comment-1" rowspan="1">Jump back until all the enemies slots checked</td>
</tr>
<tr>
<td class="address-1"><span id="51803"></span>CA5B</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="51804"></span>
<div class="comments">
<div class="paragraph">
create a new enemy
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="51804"></span>CA5C</td>
<td class="instruction">LD DE,$000C</td>
<td class="comment-1" rowspan="3">Point <span class="register">HL</span> to the base address for the current slot of enemy configuration</td>
</tr>
<tr>
<td class="address-1"><span id="51807"></span>CA5F</td>
<td class="instruction">AND A</td>
</tr>
<tr>
<td class="address-1"><span id="51808"></span>CA60</td>
<td class="instruction">SBC HL,DE</td>
</tr>
<tr>
<td class="address-1"><span id="51810"></span>CA62</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="2">Set <span class="register">IX</span> to this base address</td>
</tr>
<tr>
<td class="address-1"><span id="51811"></span>CA63</td>
<td class="instruction">POP IX</td>
</tr>
<tr>
<td class="address-1"><span id="51813"></span>CA65</td>
<td class="instruction">CALL $CA69</td>
<td class="comment-1" rowspan="1">Try to create a new enemy</td>
</tr>
<tr>
<td class="address-1"><span id="51816"></span>CA68</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="51817"></span>
<div class="comments">
<div class="paragraph">
computes random position
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="51817"></span>CA69</td>
<td class="instruction">CALL <a href="42269.html#42288">$A530</a></td>
<td class="comment-1" rowspan="5">Set <span class="register">A</span> a pseudo random number between 24 and 224</td>
</tr>
<tr>
<td class="address-1"><span id="51820"></span>CA6C</td>
<td class="instruction">CP $18</td>
</tr>
<tr>
<td class="address-1"><span id="51822"></span>CA6E</td>
<td class="instruction">JP C,$CA69</td>
</tr>
<tr>
<td class="address-1"><span id="51825"></span>CA71</td>
<td class="instruction">CP $E0</td>
</tr>
<tr>
<td class="address-1"><span id="51827"></span>CA73</td>
<td class="instruction">JP NC,$CA69</td>
</tr>
<tr>
<td class="address-1"><span id="51830"></span>CA76</td>
<td class="instruction">AND $F8</td>
<td class="comment-1" rowspan="1">Set the number grid (8x8) fixed</td>
</tr>
<tr>
<td class="address-1"><span id="51832"></span>CA78</td>
<td class="instruction">LD ($A248),A</td>
<td class="comment-1" rowspan="1">Set this number the x-position for the entity</td>
</tr>
<tr>
<td class="address-2"><span id="51835"></span>CA7B</td>
<td class="instruction">CALL <a href="42269.html#42288">$A530</a></td>
<td class="comment-1" rowspan="5">Set <span class="register">A</span> a pseudo random number between 32 and 168</td>
</tr>
<tr>
<td class="address-1"><span id="51838"></span>CA7E</td>
<td class="instruction">CP $20</td>
</tr>
<tr>
<td class="address-1"><span id="51840"></span>CA80</td>
<td class="instruction">JP C,$CA7B</td>
</tr>
<tr>
<td class="address-1"><span id="51843"></span>CA83</td>
<td class="instruction">CP $A8</td>
</tr>
<tr>
<td class="address-1"><span id="51845"></span>CA85</td>
<td class="instruction">JP NC,$CA7B</td>
</tr>
<tr>
<td class="address-1"><span id="51848"></span>CA88</td>
<td class="instruction">AND $F8</td>
<td class="comment-1" rowspan="1">Set the number grid (8x8) fixed</td>
</tr>
<tr>
<td class="address-1"><span id="51850"></span>CA8A</td>
<td class="instruction">LD ($A249),A</td>
<td class="comment-1" rowspan="1">Set this number the y-position for the entity</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="51853"></span>
<div class="comments">
<div class="paragraph">
check if position collides with Rex position
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="51853"></span>CA8D</td>
<td class="instruction">LD A,($A24F)</td>
<td class="comment-1" rowspan="1">Set <span class="register">A</span> the Rex x-position</td>
</tr>
<tr>
<td class="address-1"><span id="51856"></span>CA90</td>
<td class="instruction">SUB $10</td>
<td class="comment-1" rowspan="7">Jump forward if enemy x-position is not in range collision with Rex x-position</td>
</tr>
<tr>
<td class="address-1"><span id="51858"></span>CA92</td>
<td class="instruction">LD HL,$A248</td>
</tr>
<tr>
<td class="address-1"><span id="51861"></span>CA95</td>
<td class="instruction">CP (HL)</td>
</tr>
<tr>
<td class="address-1"><span id="51862"></span>CA96</td>
<td class="instruction">JP NC,$CAB2</td>
</tr>
<tr>
<td class="address-1"><span id="51865"></span>CA99</td>
<td class="instruction">ADD A,$30</td>
</tr>
<tr>
<td class="address-1"><span id="51867"></span>CA9B</td>
<td class="instruction">CP (HL)</td>
</tr>
<tr>
<td class="address-1"><span id="51868"></span>CA9C</td>
<td class="instruction">JP C,$CAB2</td>
</tr>
<tr>
<td class="address-1"><span id="51871"></span>CA9F</td>
<td class="instruction">LD A,($A250)</td>
<td class="comment-1" rowspan="1">Set <span class="register">A</span> the Rex y-position</td>
</tr>
<tr>
<td class="address-1"><span id="51874"></span>CAA2</td>
<td class="instruction">SUB $10</td>
<td class="comment-1" rowspan="7">Jump forward if enemy y-position is not in range collision with Rex y-position</td>
</tr>
<tr>
<td class="address-1"><span id="51876"></span>CAA4</td>
<td class="instruction">LD HL,$A249</td>
</tr>
<tr>
<td class="address-1"><span id="51879"></span>CAA7</td>
<td class="instruction">CP (HL)</td>
</tr>
<tr>
<td class="address-1"><span id="51880"></span>CAA8</td>
<td class="instruction">JP NC,$CAB2</td>
</tr>
<tr>
<td class="address-1"><span id="51883"></span>CAAB</td>
<td class="instruction">ADD A,$30</td>
</tr>
<tr>
<td class="address-1"><span id="51885"></span>CAAD</td>
<td class="instruction">CP (HL)</td>
</tr>
<tr>
<td class="address-1"><span id="51886"></span>CAAE</td>
<td class="instruction">JP C,$CAB2</td>
</tr>
<tr>
<td class="address-1"><span id="51889"></span>CAB1</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-2"><span id="51890"></span>CAB2</td>
<td class="instruction">CALL <a href="51958.html">$CAF6</a></td>
<td class="comment-1" rowspan="1">Check if enemy can be generated</td>
</tr>
<tr>
<td class="address-1"><span id="51893"></span>CAB5</td>
<td class="instruction">OR A</td>
<td class="comment-1" rowspan="2">Return if enemy can not be generated</td>
</tr>
<tr>
<td class="address-1"><span id="51894"></span>CAB6</td>
<td class="instruction">RET Z</td>
</tr>
<tr>
<td class="address-1"><span id="51895"></span>CAB7</td>
<td class="instruction">LD A,($A221)</td>
<td class="comment-1" rowspan="1">Set <span class="register">A</span> the type of enemy</td>
</tr>
<tr>
<td class="address-1"><span id="51898"></span>CABA</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="1">Set <span class="register">L</span> the type of enemy</td>
</tr>
<tr>
<td class="address-1"><span id="51899"></span>CABB</td>
<td class="instruction">BIT 7,A</td>
<td class="comment-1" rowspan="2">Jump forward if generate random FOOT MAN bit is not set</td>
</tr>
<tr>
<td class="address-1"><span id="51901"></span>CABD</td>
<td class="instruction">JP Z,$CACE</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="51904"></span>
<div class="comments">
<div class="paragraph">
try to generate random FOOT MAN
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="51904"></span>CAC0</td>
<td class="instruction">AND $7F</td>
<td class="comment-1" rowspan="2">Set <span class="register">L</span> the type of enemy to generate</td>
</tr>
<tr>
<td class="address-1"><span id="51906"></span>CAC2</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="address-1"><span id="51907"></span>CAC3</td>
<td class="instruction">CALL <a href="42269.html#42288">$A530</a></td>
<td class="comment-1" rowspan="2">Set <span class="register">A</span> a pseudo random number between 0 an 1</td>
</tr>
<tr>
<td class="address-1"><span id="51910"></span>CAC6</td>
<td class="instruction">AND $01</td>
</tr>
<tr>
<td class="address-1"><span id="51912"></span>CAC8</td>
<td class="instruction">OR A</td>
<td class="comment-1" rowspan="2">if random number is 1 then generate FOOT MAN</td>
</tr>
<tr>
<td class="address-1"><span id="51913"></span>CAC9</td>
<td class="instruction">JP Z,$CACE</td>
</tr>
<tr>
<td class="address-1"><span id="51916"></span>CACC</td>
<td class="instruction">LD L,$00</td>
<td class="comment-1" rowspan="1">Generate FOOT MAN</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="51918"></span>
<div class="comments">
<div class="paragraph">
generate enemy
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="51918"></span>CACE</td>
<td class="instruction">LD A,L</td>
<td class="comment-1" rowspan="1">Set <span class="register">A</span> the new enemy type to create</td>
</tr>
<tr>
<td class="address-1"><span id="51919"></span>CACF</td>
<td class="instruction">CALL <a href="52087.html#52090">$CB7A</a></td>
<td class="comment-1" rowspan="1">Configure the new enemy</td>
</tr>
<tr>
<td class="address-1"><span id="51922"></span>CAD2</td>
<td class="instruction">LD A,($A248)</td>
<td class="comment-1" rowspan="2">Set x-pixel-position for enemy</td>
</tr>
<tr>
<td class="address-1"><span id="51925"></span>CAD5</td>
<td class="instruction">LD (IX+$00),A</td>
</tr>
<tr>
<td class="address-1"><span id="51928"></span>CAD8</td>
<td class="instruction">LD A,($A249)</td>
<td class="comment-1" rowspan="2">Set y-pixel-position for enemy</td>
</tr>
<tr>
<td class="address-1"><span id="51931"></span>CADB</td>
<td class="instruction">LD (IX+$01),A</td>
</tr>
<tr>
<td class="address-1"><span id="51934"></span>CADE</td>
<td class="instruction">CALL <a href="42269.html">$A51D</a></td>
<td class="comment-1" rowspan="3">Set random face direction</td>
</tr>
<tr>
<td class="address-1"><span id="51937"></span>CAE1</td>
<td class="instruction">AND $01</td>
</tr>
<tr>
<td class="address-1"><span id="51939"></span>CAE3</td>
<td class="instruction">LD (IX+$02),A</td>
</tr>
<tr>
<td class="address-1"><span id="51942"></span>CAE6</td>
<td class="instruction">CALL <a href="40676.html">$9EE4</a></td>
<td class="comment-1" rowspan="1">Initialize teleporting data</td>
</tr>
<tr>
<td class="address-1"><span id="51945"></span>CAE9</td>
<td class="instruction">LD A,(IX+$09)</td>
<td class="comment-1" rowspan="3">Return if enemy is not FOOT MAN</td>
</tr>
<tr>
<td class="address-1"><span id="51948"></span>CAEC</td>
<td class="instruction">OR A</td>
</tr>
<tr>
<td class="address-1"><span id="51949"></span>CAED</td>
<td class="instruction">RET NZ</td>
</tr>
<tr>
<td class="address-1"><span id="51950"></span>CAEE</td>
<td class="instruction">CALL <a href="50664.html#50701">$C60D</a></td>
<td class="comment-1" rowspan="1">Configure FOOT MAN for stand-by position</td>
</tr>
<tr>
<td class="address-1"><span id="51953"></span>CAF1</td>
<td class="instruction">LD (IX+$11),$18</td>
<td class="comment-1" rowspan="1">Set state change counter</td>
</tr>
<tr>
<td class="address-1"><span id="51957"></span>CAF5</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="51683.html">C9E3</a>
</td>
<td class="up">Up: <a href="../maps/all.html#51765">Map</a></td>
<td class="next">
Next: <a href="51958.html">CAF6</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Rex (Side B) RAM disassembly 20211106</div>
<div class="copyright">&#169; 1988 Martech Games Ltd. &#169; 2021 Andreu Font.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.5.</div>
</footer>
</body>
</html>