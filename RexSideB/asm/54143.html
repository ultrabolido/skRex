<!DOCTYPE html>
<html>
<head>
<title>Rex: Routine at D37F</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../skoolkit-dark.css" />
<link rel="stylesheet" type="text/css" href="../rex.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/scr/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="54127.html">D36F</a>
</td>
<td class="up">Up: <a href="../maps/all.html#54143">Map</a></td>
<td class="next">
Next: <a href="54308.html">D424</a>
</td>
</tr>
</table>
<div class="description">D37F: Configure sound channel and mixer register</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="38531.html">9683</a>, <a href="38919.html">9807</a>, <a href="39395.html">99E3</a>, <a href="39847.html">9BA7</a>, <a href="40237.html">9D2D</a>, <a href="40469.html">9E15</a>, <a href="40509.html">9E3D</a>, <a href="41208.html">A0F8</a>, <a href="46412.html">B54C</a>, <a href="46412.html#46504">B5A8</a>, <a href="46731.html#47120">B810</a>, <a href="53173.html">CFB5</a>, <a href="53173.html#53764">D204</a> and <a href="53173.html#53804">D22C</a>.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">DE</td>
<td class="register-desc">Sound data address</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="54143"></span>D37F</td>
<td class="instruction">PUSH IY</td>
<td class="comment-1" rowspan="3">Save <span class="register">IY</span>, <span class="register">IX</span> and <span class="register">BC</span></td>
</tr>
<tr>
<td class="address-1"><span id="54145"></span>D381</td>
<td class="instruction">PUSH IX</td>
</tr>
<tr>
<td class="address-1"><span id="54147"></span>D383</td>
<td class="instruction">PUSH BC</td>
</tr>
<tr>
<td class="address-1"><span id="54148"></span>D384</td>
<td class="instruction">PUSH DE</td>
<td class="comment-1" rowspan="2">Copy <span class="register">DE</span> into <span class="register">IY</span></td>
</tr>
<tr>
<td class="address-1"><span id="54149"></span>D385</td>
<td class="instruction">POP IY</td>
</tr>
<tr>
<td class="address-1"><span id="54151"></span>D387</td>
<td class="instruction">CALL $D390</td>
<td class="comment-1" rowspan="1">Configure sound channel and mixer register</td>
</tr>
<tr>
<td class="address-1"><span id="54154"></span>D38A</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="3">Restore <span class="register">IY</span>, <span class="register">IX</span> and <span class="register">BC</span></td>
</tr>
<tr>
<td class="address-1"><span id="54155"></span>D38B</td>
<td class="instruction">POP IX</td>
</tr>
<tr>
<td class="address-1"><span id="54157"></span>D38D</td>
<td class="instruction">POP IY</td>
</tr>
<tr>
<td class="address-1"><span id="54159"></span>D38F</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="54160"></span>
<div class="comments">
<div class="paragraph">
Configure sound channel and mixer register
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="54160"></span>D390</td>
<td class="instruction">LD A,(IY+$00)</td>
<td class="comment-1" rowspan="9">Set <span class="register">IX</span> to the base address for the channel to configure</td>
</tr>
<tr>
<td class="address-1"><span id="54163"></span>D393</td>
<td class="instruction">DEC A</td>
</tr>
<tr>
<td class="address-1"><span id="54164"></span>D394</td>
<td class="instruction">SLA A</td>
</tr>
<tr>
<td class="address-1"><span id="54166"></span>D396</td>
<td class="instruction">SLA A</td>
</tr>
<tr>
<td class="address-1"><span id="54168"></span>D398</td>
<td class="instruction">SLA A</td>
</tr>
<tr>
<td class="address-1"><span id="54170"></span>D39A</td>
<td class="instruction">LD C,A</td>
</tr>
<tr>
<td class="address-1"><span id="54171"></span>D39B</td>
<td class="instruction">LD B,$00</td>
</tr>
<tr>
<td class="address-1"><span id="54173"></span>D39D</td>
<td class="instruction">LD IX,$D5CA</td>
</tr>
<tr>
<td class="address-1"><span id="54177"></span>D3A1</td>
<td class="instruction">ADD IX,BC</td>
</tr>
<tr>
<td class="address-1"><span id="54179"></span>D3A3</td>
<td class="instruction">LD A,(IY+$02)</td>
<td class="comment-1" rowspan="2">Set number of tones</td>
</tr>
<tr>
<td class="address-1"><span id="54182"></span>D3A6</td>
<td class="instruction">LD (IX+$00),A</td>
</tr>
<tr>
<td class="address-1"><span id="54185"></span>D3A9</td>
<td class="instruction">LD A,(IY+$06)</td>
<td class="comment-1" rowspan="2">Set variation counter</td>
</tr>
<tr>
<td class="address-1"><span id="54188"></span>D3AC</td>
<td class="instruction">LD (IX+$01),A</td>
</tr>
<tr>
<td class="address-1"><span id="54191"></span>D3AF</td>
<td class="instruction">PUSH IY</td>
<td class="comment-1" rowspan="6">Set address for sound data</td>
</tr>
<tr>
<td class="address-1"><span id="54193"></span>D3B1</td>
<td class="instruction">POP HL</td>
</tr>
<tr>
<td class="address-1"><span id="54194"></span>D3B2</td>
<td class="instruction">LD BC,$0006</td>
</tr>
<tr>
<td class="address-1"><span id="54197"></span>D3B5</td>
<td class="instruction">ADD HL,BC</td>
</tr>
<tr>
<td class="address-1"><span id="54198"></span>D3B6</td>
<td class="instruction">LD (IX+$02),L</td>
</tr>
<tr>
<td class="address-1"><span id="54201"></span>D3B9</td>
<td class="instruction">LD (IX+$03),H</td>
</tr>
<tr>
<td class="address-1"><span id="54204"></span>D3BC</td>
<td class="instruction">LD A,(IY+$04)</td>
<td class="comment-1" rowspan="4">Set base fine and coarse pitch</td>
</tr>
<tr>
<td class="address-1"><span id="54207"></span>D3BF</td>
<td class="instruction">LD (IX+$04),A</td>
</tr>
<tr>
<td class="address-1"><span id="54210"></span>D3C2</td>
<td class="instruction">LD A,(IY+$05)</td>
</tr>
<tr>
<td class="address-1"><span id="54213"></span>D3C5</td>
<td class="instruction">LD (IX+$05),A</td>
</tr>
<tr>
<td class="address-1"><span id="54216"></span>D3C8</td>
<td class="instruction">LD A,(IY+$03)</td>
<td class="comment-1" rowspan="2">Set channel volume</td>
</tr>
<tr>
<td class="address-1"><span id="54219"></span>D3CB</td>
<td class="instruction">LD (IX+$07),A</td>
</tr>
<tr>
<td class="address-1"><span id="54222"></span>D3CE</td>
<td class="instruction">LD A,(IY+$01)</td>
<td class="comment-1" rowspan="1">Set <span class="register">A</span> to the data mixer</td>
</tr>
<tr>
<td class="address-1"><span id="54225"></span>D3D1</td>
<td class="instruction">CP $00</td>
<td class="comment-1" rowspan="2">Jump forward if not zero</td>
</tr>
<tr>
<td class="address-1"><span id="54227"></span>D3D3</td>
<td class="instruction">JP NZ,$D3E9</td>
</tr>
<tr>
<td class="address-1"><span id="54230"></span>D3D6</td>
<td class="instruction">LD B,(IY+$00)</td>
<td class="comment-1" rowspan="4">Disable noise for selected channel</td>
</tr>
<tr>
<td class="address-1"><span id="54233"></span>D3D9</td>
<td class="instruction">LD C,$04</td>
</tr>
<tr>
<td class="address-2"><span id="54235"></span>D3DB</td>
<td class="instruction">SLA C</td>
</tr>
<tr>
<td class="address-1"><span id="54237"></span>D3DD</td>
<td class="instruction">DJNZ $D3DB</td>
</tr>
<tr>
<td class="address-1"><span id="54239"></span>D3DF</td>
<td class="instruction">LD A,($D5ED)</td>
<td class="comment-1" rowspan="3">Disable noise for the selected channel into the current data mixer</td>
</tr>
<tr>
<td class="address-1"><span id="54242"></span>D3E2</td>
<td class="instruction">OR C</td>
</tr>
<tr>
<td class="address-1"><span id="54243"></span>D3E3</td>
<td class="instruction">LD ($D5ED),A</td>
</tr>
<tr>
<td class="address-1"><span id="54246"></span>D3E6</td>
<td class="instruction">JP $D41A</td>
<td class="comment-1" rowspan="1">Send this data to the mixer register</td>
</tr>
<tr>
<td class="address-2"><span id="54249"></span>D3E9</td>
<td class="instruction">LD A,($D5ED)</td>
<td class="comment-1" rowspan="2">Set <span class="register">B</span> the current data mixer</td>
</tr>
<tr>
<td class="address-1"><span id="54252"></span>D3EC</td>
<td class="instruction">LD B,A</td>
</tr>
<tr>
<td class="address-1"><span id="54253"></span>D3ED</td>
<td class="instruction">LD A,(IY+$00)</td>
<td class="comment-1" rowspan="5">if channel 1 then disable tone in channel 1 and enable noise in channel 1</td>
</tr>
<tr>
<td class="address-1"><span id="54256"></span>D3F0</td>
<td class="instruction">CP $01</td>
</tr>
<tr>
<td class="address-1"><span id="54258"></span>D3F2</td>
<td class="instruction">JP NZ,$D3FC</td>
</tr>
<tr>
<td class="address-1"><span id="54261"></span>D3F5</td>
<td class="instruction">RES 3,B</td>
</tr>
<tr>
<td class="address-1"><span id="54263"></span>D3F7</td>
<td class="instruction">SET 0,B</td>
</tr>
<tr>
<td class="address-1"><span id="54265"></span>D3F9</td>
<td class="instruction">JP $D40C</td>
<td class="comment-1" rowspan="1">Jump to update data mixer</td>
</tr>
<tr>
<td class="address-2"><span id="54268"></span>D3FC</td>
<td class="instruction">CP $02</td>
<td class="comment-1" rowspan="4">if channel 2 then disable tone in channel 2 and enable noise in channel 2</td>
</tr>
<tr>
<td class="address-1"><span id="54270"></span>D3FE</td>
<td class="instruction">JP NZ,$D408</td>
</tr>
<tr>
<td class="address-1"><span id="54273"></span>D401</td>
<td class="instruction">RES 4,B</td>
</tr>
<tr>
<td class="address-1"><span id="54275"></span>D403</td>
<td class="instruction">SET 1,B</td>
</tr>
<tr>
<td class="address-1"><span id="54277"></span>D405</td>
<td class="instruction">JP $D40C</td>
<td class="comment-1" rowspan="1">Jump to update data mixer</td>
</tr>
<tr>
<td class="address-2"><span id="54280"></span>D408</td>
<td class="instruction">RES 5,B</td>
<td class="comment-1" rowspan="2">if channel 3 then disable tone in channel 3 and enable noise in channel 3</td>
</tr>
<tr>
<td class="address-1"><span id="54282"></span>D40A</td>
<td class="instruction">SET 2,B</td>
</tr>
<tr>
<td class="address-2"><span id="54284"></span>D40C</td>
<td class="instruction">LD A,B</td>
<td class="comment-1" rowspan="2">Update data mixer</td>
</tr>
<tr>
<td class="address-1"><span id="54285"></span>D40D</td>
<td class="instruction">LD ($D5ED),A</td>
</tr>
<tr>
<td class="address-1"><span id="54288"></span>D410</td>
<td class="instruction">CALL $D41A</td>
<td class="comment-1" rowspan="1">Send this data to the mixer register</td>
</tr>
<tr>
<td class="address-1"><span id="54291"></span>D413</td>
<td class="instruction">LD A,(IY+$01)</td>
<td class="comment-1" rowspan="2">Copy noise/tone enable/disable</td>
</tr>
<tr>
<td class="address-1"><span id="54294"></span>D416</td>
<td class="instruction">LD (IX+$06),A</td>
</tr>
<tr>
<td class="address-1"><span id="54297"></span>D419</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="54298"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="54086.html">D346</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="54298"></span>D41A</td>
<td class="instruction">LD A,($D5ED)</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="54301"></span>D41D</td>
<td class="instruction">LD D,$07</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="54303"></span>D41F</td>
<td class="instruction">LD E,A</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="54304"></span>D420</td>
<td class="instruction">CALL <a href="54513.html">$D4F1</a></td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="54307"></span>D423</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="54127.html">D36F</a>
</td>
<td class="up">Up: <a href="../maps/all.html#54143">Map</a></td>
<td class="next">
Next: <a href="54308.html">D424</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Rex (Side B) RAM disassembly 20211106</div>
<div class="copyright">&#169; 1988 Martech Games Ltd. &#169; 2021 Andreu Font.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.5.</div>
</footer>
</body>
</html>