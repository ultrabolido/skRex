<!DOCTYPE html>
<html>
<head>
<title>Rex: Routine at CEE5</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../skoolkit-dark.css" />
<link rel="stylesheet" type="text/css" href="../rex.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/scr/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="52852.html">CE74</a>
</td>
<td class="up">Up: <a href="../maps/all.html#52965">Map</a></td>
<td class="next">
Next: <a href="53081.html">CF59</a>
</td>
</tr>
</table>
<div class="description">CEE5: Handle Rex falling</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="38000.html">9470</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="52965"></span>CEE5</td>
<td class="instruction">LD A,($A256)</td>
<td class="comment-1" rowspan="3">Return if Rex is jumping</td>
</tr>
<tr>
<td class="address-1"><span id="52968"></span>CEE8</td>
<td class="instruction">OR A</td>
</tr>
<tr>
<td class="address-1"><span id="52969"></span>CEE9</td>
<td class="instruction">RET NZ</td>
</tr>
<tr>
<td class="address-1"><span id="52970"></span>CEEA</td>
<td class="instruction">LD A,($A250)</td>
<td class="comment-1" rowspan="3">Add falling speed to y-position of Rex</td>
</tr>
<tr>
<td class="address-1"><span id="52973"></span>CEED</td>
<td class="instruction">LD HL,$A255</td>
</tr>
<tr>
<td class="address-1"><span id="52976"></span>CEF0</td>
<td class="instruction">ADD A,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="52977"></span>CEF1</td>
<td class="instruction">CP $BA</td>
<td class="comment-1" rowspan="2">if y-position is greater then 186 jump to check bottom room</td>
</tr>
<tr>
<td class="address-1"><span id="52979"></span>CEF3</td>
<td class="instruction">JP NC,$CF3B</td>
</tr>
<tr>
<td class="address-1"><span id="52982"></span>CEF6</td>
<td class="instruction">LD ($A250),A</td>
<td class="comment-1" rowspan="1">Set the new y-position</td>
</tr>
<tr>
<td class="address-1"><span id="52985"></span>CEF9</td>
<td class="instruction">AND $07</td>
<td class="comment-1" rowspan="3">Return if y-position is not grid fixed</td>
</tr>
<tr>
<td class="address-1"><span id="52987"></span>CEFB</td>
<td class="instruction">OR A</td>
</tr>
<tr>
<td class="address-1"><span id="52988"></span>CEFC</td>
<td class="instruction">RET NZ</td>
</tr>
<tr>
<td class="address-1"><span id="52989"></span>CEFD</td>
<td class="instruction">LD A,($A24F)</td>
<td class="comment-1" rowspan="2">Set <a href="41544.html">A248</a> the x-position of Rex</td>
</tr>
<tr>
<td class="address-1"><span id="52992"></span>CF00</td>
<td class="instruction">LD ($A248),A</td>
</tr>
<tr>
<td class="address-1"><span id="52995"></span>CF03</td>
<td class="instruction">LD A,($A250)</td>
<td class="comment-1" rowspan="2">Set <a href="41545.html">A249</a> the y-position of Rex</td>
</tr>
<tr>
<td class="address-1"><span id="52998"></span>CF06</td>
<td class="instruction">LD ($A249),A</td>
</tr>
<tr>
<td class="address-1"><span id="53001"></span>CF09</td>
<td class="instruction">LD A,($A254)</td>
<td class="comment-1" rowspan="1">Set <span class="register">A</span> the face direction</td>
</tr>
<tr>
<td class="address-1"><span id="53004"></span>CF0C</td>
<td class="instruction">CALL <a href="42667.html">$A6AB</a></td>
<td class="comment-1" rowspan="1">Computes address position in tile type buffer based on (x,y) position on screen</td>
</tr>
<tr>
<td class="address-1"><span id="53007"></span>CF0F</td>
<td class="instruction">LD DE,$0061</td>
<td class="comment-1" rowspan="2">Set <span class="register">HL</span> to point into tile type buffer under Rex feet</td>
</tr>
<tr>
<td class="address-1"><span id="53010"></span>CF12</td>
<td class="instruction">ADD HL,DE</td>
</tr>
<tr>
<td class="address-1"><span id="53011"></span>CF13</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Set <span class="register">A</span> the tile type</td>
</tr>
<tr>
<td class="address-1"><span id="53012"></span>CF14</td>
<td class="instruction">CALL <a href="52725.html#52759">$CE17</a></td>
<td class="comment-1" rowspan="1">Check if tile type is 'background'</td>
</tr>
<tr>
<td class="address-1"><span id="53015"></span>CF17</td>
<td class="instruction">JP NZ,$CF36</td>
<td class="comment-1" rowspan="1">Jump to stop falling if not background</td>
</tr>
<tr>
<td class="address-1"><span id="53018"></span>CF1A</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Increment address</td>
</tr>
<tr>
<td class="address-1"><span id="53019"></span>CF1B</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Set <span class="register">A</span> the tile type</td>
</tr>
<tr>
<td class="address-1"><span id="53020"></span>CF1C</td>
<td class="instruction">CALL <a href="52725.html#52759">$CE17</a></td>
<td class="comment-1" rowspan="1">Check if tile type is 'background'</td>
</tr>
<tr>
<td class="address-1"><span id="53023"></span>CF1F</td>
<td class="instruction">JP NZ,$CF36</td>
<td class="comment-1" rowspan="1">Jump to stop falling if not background</td>
</tr>
<tr>
<td class="address-1"><span id="53026"></span>CF22</td>
<td class="instruction">LD A,($A25D)</td>
<td class="comment-1" rowspan="3">If Rex collides with tile type $03 (tile of death) then jump to kill Rex</td>
</tr>
<tr>
<td class="address-1"><span id="53029"></span>CF25</td>
<td class="instruction">CP $03</td>
</tr>
<tr>
<td class="address-1"><span id="53031"></span>CF27</td>
<td class="instruction">CALL Z,<a href="40133.html">$9CC5</a></td>
</tr>
<tr>
<td class="address-1"><span id="53034"></span>CF2A</td>
<td class="instruction">LD A,($A255)</td>
<td class="comment-1" rowspan="2">Increase falling speed by 2</td>
</tr>
<tr>
<td class="address-1"><span id="53037"></span>CF2D</td>
<td class="instruction">ADD A,$02</td>
</tr>
<tr>
<td class="address-1"><span id="53039"></span>CF2F</td>
<td class="instruction">CP $06</td>
<td class="comment-1" rowspan="2">Return if falling speed greater than 4</td>
</tr>
<tr>
<td class="address-1"><span id="53041"></span>CF31</td>
<td class="instruction">RET Z</td>
</tr>
<tr>
<td class="address-1"><span id="53042"></span>CF32</td>
<td class="instruction">LD ($A255),A</td>
<td class="comment-1" rowspan="1">Set the new falling speed</td>
</tr>
<tr>
<td class="address-1"><span id="53045"></span>CF35</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="53046"></span>
<div class="comments">
<div class="paragraph">
Rex has finished falling
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="53046"></span>CF36</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="2">Set falling speed to 0</td>
</tr>
<tr>
<td class="address-1"><span id="53047"></span>CF37</td>
<td class="instruction">LD ($A255),A</td>
</tr>
<tr>
<td class="address-1"><span id="53050"></span>CF3A</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="53051"></span>
<div class="comments">
<div class="paragraph">
Rex has fallen through bottom room
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="53051"></span>CF3B</td>
<td class="instruction">LD A,($A228)</td>
<td class="comment-1" rowspan="3">If no bottom room connection then jump to kill Rex</td>
</tr>
<tr>
<td class="address-1"><span id="53054"></span>CF3E</td>
<td class="instruction">OR A</td>
</tr>
<tr>
<td class="address-1"><span id="53055"></span>CF3F</td>
<td class="instruction">JP Z,$CF4E</td>
</tr>
<tr>
<td class="address-1"><span id="53058"></span>CF42</td>
<td class="instruction">LD ($A251),A</td>
<td class="comment-1" rowspan="1">Set the new room</td>
</tr>
<tr>
<td class="address-1"><span id="53061"></span>CF45</td>
<td class="instruction">LD A,$08</td>
<td class="comment-1" rowspan="2">Set the new y-position of Rex as 8</td>
</tr>
<tr>
<td class="address-1"><span id="53063"></span>CF47</td>
<td class="instruction">LD ($A250),A</td>
</tr>
<tr>
<td class="address-1"><span id="53066"></span>CF4A</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore <span class="register">BC</span></td>
</tr>
<tr>
<td class="address-1"><span id="53067"></span>CF4B</td>
<td class="instruction">JP <a href="51661.html">$C9CD</a></td>
<td class="comment-1" rowspan="1">Check for end game room</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="53070"></span>
<div class="comments">
<div class="paragraph">
No room connection, kill Rex
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="53070"></span>CF4E</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="3">Set Rex to not jumping nor falling</td>
</tr>
<tr>
<td class="address-1"><span id="53071"></span>CF4F</td>
<td class="instruction">LD ($A255),A</td>
</tr>
<tr>
<td class="address-1"><span id="53074"></span>CF52</td>
<td class="instruction">LD ($A256),A</td>
</tr>
<tr>
<td class="address-1"><span id="53077"></span>CF55</td>
<td class="instruction">CALL <a href="40133.html">$9CC5</a></td>
<td class="comment-1" rowspan="1">Handle Rex dead</td>
</tr>
<tr>
<td class="address-1"><span id="53080"></span>CF58</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="52852.html">CE74</a>
</td>
<td class="up">Up: <a href="../maps/all.html#52965">Map</a></td>
<td class="next">
Next: <a href="53081.html">CF59</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Rex (Side B) RAM disassembly 20211106</div>
<div class="copyright">&#169; 1988 Martech Games Ltd. &#169; 2021 Andreu Font.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.5.</div>
</footer>
</body>
</html>