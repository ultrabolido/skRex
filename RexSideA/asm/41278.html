<!DOCTYPE html>
<html>
<head>
<title>Rex (Side A): Routine at A13E</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../skoolkit-dark.css" />
<link rel="stylesheet" type="text/css" href="../rex.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/scr/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="41267.html">A133</a>
</td>
<td class="up">Up: <a href="../maps/all.html#41278">Map</a></td>
<td class="next">
Next: <a href="41381.html">A1A5</a>
</td>
</tr>
</table>
<div class="description">A13E: Draws a windows in the display file</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Reads the text definition data format (explained at <a href="43694.html">AAAE</a>) and draws the border and content of the windows Used by the routines at <a href="38010.html">947A</a>, <a href="40054.html">9C76</a>, <a href="42958.html">A7CE</a>, <a href="55409.html">D871</a>, <a href="56000.html">DAC0</a> and <a href="56660.html#57042">DED2</a>
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">IX</td>
<td class="register-desc">Address of the text definition data</td>
</tr>
<tr>
<td class="register">B</td>
<td class="register-desc">Number of lines of the windows</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="41278"></span>A13E</td>
<td class="instruction">PUSH IX</td>
<td class="comment-1" rowspan="2">Save <span class="register">IX</span> and <span class="register">BC</span></td>
</tr>
<tr>
<td class="address-1"><span id="41280"></span>A140</td>
<td class="instruction">PUSH BC</td>
</tr>
<tr>
<td class="address-1"><span id="41281"></span>A141</td>
<td class="instruction">LD A,$01</td>
<td class="comment-1" rowspan="2">Initialise the width of the popup at <a href="41109.html">A095</a></td>
</tr>
<tr>
<td class="address-1"><span id="41283"></span>A143</td>
<td class="instruction">LD ($A095),A</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="41286"></span>
<div class="comments">
<div class="paragraph">
First compute the width of the windows based on the max length of all the lines of text plus 2 Special case: the first line of text computes a width of length of text plus 1
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="41286"></span>A146</td>
<td class="instruction">LD A,$01</td>
<td class="comment-1" rowspan="2">Initialise the temporal computed width of the windows at <a href="41107.html">A093</a></td>
</tr>
<tr>
<td class="address-1"><span id="41288"></span>A148</td>
<td class="instruction">LD ($A093),A</td>
</tr>
<tr>
<td class="address-1"><span id="41291"></span>A14B</td>
<td class="instruction">LD DE,$0003</td>
<td class="comment-1" rowspan="2">In the first iteration, point <span class="register">IX</span> to the first character of the line. Subsequent iterations points to the vertical position</td>
</tr>
<tr>
<td class="address-1"><span id="41294"></span>A14E</td>
<td class="instruction">ADD IX,DE</td>
</tr>
<tr>
<td class="address-2"><span id="41296"></span>A150</td>
<td class="instruction">LD A,(IX+$00)</td>
<td class="comment-1" rowspan="1">Pick up the character at <span class="register">IX</span></td>
</tr>
<tr>
<td class="address-1"><span id="41299"></span>A153</td>
<td class="instruction">OR A</td>
<td class="comment-1" rowspan="1">Is the character an end of marker ($00)?</td>
</tr>
<tr>
<td class="address-1"><span id="41300"></span>A154</td>
<td class="instruction">JP Z,$A160</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="41303"></span>A157</td>
<td class="instruction">LD HL,$A093</td>
<td class="comment-1" rowspan="2">Increment the temporal computed width at <a href="41107.html">A093</a></td>
</tr>
<tr>
<td class="address-1"><span id="41306"></span>A15A</td>
<td class="instruction">INC (HL)</td>
</tr>
<tr>
<td class="address-1"><span id="41307"></span>A15B</td>
<td class="instruction">INC IX</td>
<td class="comment-1" rowspan="1">Increment the address pointer to read the next character</td>
</tr>
<tr>
<td class="address-1"><span id="41309"></span>A15D</td>
<td class="instruction">JP $A150</td>
<td class="comment-1" rowspan="1">Jump back to <a href="41278.html#41296">A150</a> and repeat the process</td>
</tr>
<tr>
<td class="address-2"><span id="41312"></span>A160</td>
<td class="instruction">LD A,($A093)</td>
<td class="comment-1" rowspan="3">Compare the width computed in the last iteration with the max width previously saved</td>
</tr>
<tr>
<td class="address-1"><span id="41315"></span>A163</td>
<td class="instruction">LD HL,$A095</td>
</tr>
<tr>
<td class="address-1"><span id="41318"></span>A166</td>
<td class="instruction">CP (HL)</td>
</tr>
<tr>
<td class="address-1"><span id="41319"></span>A167</td>
<td class="instruction">JP C,$A16D</td>
<td class="comment-1" rowspan="1">Jump to <a href="41278.html#41325">A16D</a> if the max width is greater or equal than the current computed width</td>
</tr>
<tr>
<td class="address-1"><span id="41322"></span>A16A</td>
<td class="instruction">LD ($A095),A</td>
<td class="comment-1" rowspan="1">Update the max width of the windows at <a href="41109.html">A095</a> with the new computed value</td>
</tr>
<tr>
<td class="address-2"><span id="41325"></span>A16D</td>
<td class="instruction">DJNZ $A146</td>
<td class="comment-1" rowspan="1">Jump back while there are lines to process</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="41327"></span>
<div class="comments">
<div class="paragraph">
The next section of code obtain the position and color attributes of the windows
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="41327"></span>A16F</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="2">Restore <span class="register">BC</span> and <span class="register">IX</span></td>
</tr>
<tr>
<td class="address-1"><span id="41328"></span>A170</td>
<td class="instruction">POP IX</td>
</tr>
<tr>
<td class="address-1"><span id="41330"></span>A172</td>
<td class="instruction">PUSH IX</td>
<td class="comment-1" rowspan="2">Save <span class="register">BC</span> and <span class="register">IX</span></td>
</tr>
<tr>
<td class="address-1"><span id="41332"></span>A174</td>
<td class="instruction">PUSH BC</td>
</tr>
<tr>
<td class="address-1"><span id="41333"></span>A175</td>
<td class="instruction">LD A,B</td>
<td class="comment-1" rowspan="2">Is there only one line of text?</td>
</tr>
<tr>
<td class="address-1"><span id="41334"></span>A176</td>
<td class="instruction">CP $01</td>
</tr>
<tr>
<td class="address-1"><span id="41336"></span>A178</td>
<td class="instruction">JP NZ,$A17F</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="41339"></span>A17B</td>
<td class="instruction">LD HL,$A095</td>
<td class="comment-1" rowspan="2">Increment the width of the windows by one at <a href="41109.html">A095</a>. This account for the special case described above</td>
</tr>
<tr>
<td class="address-1"><span id="41342"></span>A17E</td>
<td class="instruction">INC (HL)</td>
</tr>
<tr>
<td class="address-2"><span id="41343"></span>A17F</td>
<td class="instruction">LD A,(IX+$01)</td>
<td class="comment-1" rowspan="1">Pick up the horizontal position of the first line of text</td>
</tr>
<tr>
<td class="address-1"><span id="41346"></span>A182</td>
<td class="instruction">SUB $03</td>
<td class="comment-1" rowspan="1">Substract 3 to obtain the horizontal position of the windows: one for the border and two for the left margin.</td>
</tr>
<tr>
<td class="address-1"><span id="41348"></span>A184</td>
<td class="instruction">LD H,A</td>
<td class="comment-1" rowspan="1">Save the horizontal position of the windows at <span class="register">H</span></td>
</tr>
<tr>
<td class="address-1"><span id="41349"></span>A185</td>
<td class="instruction">LD A,(IX+$02)</td>
<td class="comment-1" rowspan="1">Pick up the vertical position of the first line of text</td>
</tr>
<tr>
<td class="address-1"><span id="41352"></span>A188</td>
<td class="instruction">SRL A</td>
<td class="comment-1" rowspan="3">The position is defined in bits 7-3 so move this value to bits 4-0</td>
</tr>
<tr>
<td class="address-1"><span id="41354"></span>A18A</td>
<td class="instruction">SRL A</td>
</tr>
<tr>
<td class="address-1"><span id="41356"></span>A18C</td>
<td class="instruction">SRL A</td>
</tr>
<tr>
<td class="address-1"><span id="41358"></span>A18E</td>
<td class="instruction">DEC A</td>
<td class="comment-1" rowspan="1">Decrement by one to account for the top border</td>
</tr>
<tr>
<td class="address-1"><span id="41359"></span>A18F</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="1">Save the vertical position of the windows at <span class="register">L</span></td>
</tr>
<tr>
<td class="address-1"><span id="41360"></span>A190</td>
<td class="instruction">LD E,B</td>
<td class="comment-1" rowspan="1">Save the number of lines of the windows in register E</td>
</tr>
<tr>
<td class="address-1"><span id="41361"></span>A191</td>
<td class="instruction">LD A,($A095)</td>
<td class="comment-1" rowspan="1">Pick up the width of the windows saved at <a href="41109.html">A095</a></td>
</tr>
<tr>
<td class="address-1"><span id="41364"></span>A194</td>
<td class="instruction">SUB $02</td>
<td class="comment-1" rowspan="1">Substract 2 for the borders</td>
</tr>
<tr>
<td class="address-1"><span id="41366"></span>A196</td>
<td class="instruction">LD D,A</td>
<td class="comment-1" rowspan="1">Save the width of the windows (minus borders) at <span class="register">D</span></td>
</tr>
<tr>
<td class="address-1"><span id="41367"></span>A197</td>
<td class="instruction">LD A,$47</td>
<td class="comment-1" rowspan="1">Save at <span class="register">A</span> the color attributes for the windows border</td>
</tr>
<tr>
<td class="address-1"><span id="41369"></span>A199</td>
<td class="instruction">LD C,$07</td>
<td class="comment-1" rowspan="1">Save at <span class="register">C</span> the color attributes for the windows body</td>
</tr>
<tr>
<td class="address-1"><span id="41371"></span>A19B</td>
<td class="instruction">CALL <a href="52859.html">$CE7B</a></td>
<td class="comment-1" rowspan="1">Draws the windows borders in the display file</td>
</tr>
<tr>
<td class="address-1"><span id="41374"></span>A19E</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="2">Save <span class="register">BC</span> and <span class="register">IX</span></td>
</tr>
<tr>
<td class="address-1"><span id="41375"></span>A19F</td>
<td class="instruction">POP IX</td>
</tr>
<tr>
<td class="address-1"><span id="41377"></span>A1A1</td>
<td class="instruction">CALL <a href="41695.html">$A2DF</a></td>
<td class="comment-1" rowspan="1">Print the text content of the windows in the display file</td>
</tr>
<tr>
<td class="address-1"><span id="41380"></span>A1A4</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="41267.html">A133</a>
</td>
<td class="up">Up: <a href="../maps/all.html#41278">Map</a></td>
<td class="next">
Next: <a href="41381.html">A1A5</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Rex (Side A) RAM disassembly 20211106</div>
<div class="copyright">&#169; 1988 Martech Games Ltd. &#169; 2021 Andreu Font.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.5.</div>
</footer>
</body>
</html>