<!DOCTYPE html>
<html>
<head>
<title>Rex (Side A): Routine at D14D</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../skoolkit-dark.css" />
<link rel="stylesheet" type="text/css" href="../rex.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/scr/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="53476.html">D0E4</a>
</td>
<td class="up">Up: <a href="../maps/all.html#53581">Map</a></td>
<td class="next">
Next: <a href="53689.html">D1B9</a>
</td>
</tr>
</table>
<div class="description">D14D: Handle Rex falling</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="38010.html">947A</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="53581"></span>D14D</td>
<td class="instruction">LD A,($A0BD)</td>
<td class="comment-1" rowspan="3">Return if Rex is jumping</td>
</tr>
<tr>
<td class="address-1"><span id="53584"></span>D150</td>
<td class="instruction">OR A</td>
</tr>
<tr>
<td class="address-1"><span id="53585"></span>D151</td>
<td class="instruction">RET NZ</td>
</tr>
<tr>
<td class="address-1"><span id="53586"></span>D152</td>
<td class="instruction">LD A,($A0B7)</td>
<td class="comment-1" rowspan="3">Add falling speed to y-position of Rex</td>
</tr>
<tr>
<td class="address-1"><span id="53589"></span>D155</td>
<td class="instruction">LD HL,$A0BC</td>
</tr>
<tr>
<td class="address-1"><span id="53592"></span>D158</td>
<td class="instruction">ADD A,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="53593"></span>D159</td>
<td class="instruction">CP $BA</td>
<td class="comment-1" rowspan="2">if y-position is greater then 186 jump to check bottom room</td>
</tr>
<tr>
<td class="address-1"><span id="53595"></span>D15B</td>
<td class="instruction">JP NC,$D19B</td>
</tr>
<tr>
<td class="address-1"><span id="53598"></span>D15E</td>
<td class="instruction">LD ($A0B7),A</td>
<td class="comment-1" rowspan="1">Set the new y-position</td>
</tr>
<tr>
<td class="address-1"><span id="53601"></span>D161</td>
<td class="instruction">AND $07</td>
<td class="comment-1" rowspan="3">Return if y-position is not grid fixed</td>
</tr>
<tr>
<td class="address-1"><span id="53603"></span>D163</td>
<td class="instruction">OR A</td>
</tr>
<tr>
<td class="address-1"><span id="53604"></span>D164</td>
<td class="instruction">RET NZ</td>
</tr>
<tr>
<td class="address-1"><span id="53605"></span>D165</td>
<td class="instruction">LD A,($A0B6)</td>
<td class="comment-1" rowspan="2">Set <a href="41135.html">A0AF</a> the x-position of Rex</td>
</tr>
<tr>
<td class="address-1"><span id="53608"></span>D168</td>
<td class="instruction">LD ($A0AF),A</td>
</tr>
<tr>
<td class="address-1"><span id="53611"></span>D16B</td>
<td class="instruction">LD A,($A0B7)</td>
<td class="comment-1" rowspan="2">Set <a href="41143.html">A0B7</a> the y-position of Rex</td>
</tr>
<tr>
<td class="address-1"><span id="53614"></span>D16E</td>
<td class="instruction">LD ($A0B0),A</td>
</tr>
<tr>
<td class="address-1"><span id="53617"></span>D171</td>
<td class="instruction">LD A,($A0BB)</td>
<td class="comment-1" rowspan="1">Set <span class="register">A</span> the face direction</td>
</tr>
<tr>
<td class="address-1"><span id="53620"></span>D174</td>
<td class="instruction">CALL <a href="42243.html">$A503</a></td>
<td class="comment-1" rowspan="1">Computes address position in tile type buffer based on (x,y) position on screen</td>
</tr>
<tr>
<td class="address-1"><span id="53623"></span>D177</td>
<td class="instruction">LD DE,$0061</td>
<td class="comment-1" rowspan="2">Set <span class="register">HL</span> to point into tile type buffer under Rex feet</td>
</tr>
<tr>
<td class="address-1"><span id="53626"></span>D17A</td>
<td class="instruction">ADD HL,DE</td>
</tr>
<tr>
<td class="address-1"><span id="53627"></span>D17B</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Set <span class="register">A</span> the tile type</td>
</tr>
<tr>
<td class="address-1"><span id="53628"></span>D17C</td>
<td class="instruction">CALL <a href="53356.html#53387">$D08B</a></td>
<td class="comment-1" rowspan="1">Check if tile type is 'background'</td>
</tr>
<tr>
<td class="address-1"><span id="53631"></span>D17F</td>
<td class="instruction">JP NZ,$D196</td>
<td class="comment-1" rowspan="1">Jump to stop falling if not background</td>
</tr>
<tr>
<td class="address-1"><span id="53634"></span>D182</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Increment address</td>
</tr>
<tr>
<td class="address-1"><span id="53635"></span>D183</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Set <span class="register">A</span> the tile type</td>
</tr>
<tr>
<td class="address-1"><span id="53636"></span>D184</td>
<td class="instruction">CALL <a href="53356.html#53387">$D08B</a></td>
<td class="comment-1" rowspan="1">Check if tile type is 'background'</td>
</tr>
<tr>
<td class="address-1"><span id="53639"></span>D187</td>
<td class="instruction">JP NZ,$D196</td>
<td class="comment-1" rowspan="1">Jump to stop falling if not background</td>
</tr>
<tr>
<td class="address-1"><span id="53642"></span>D18A</td>
<td class="instruction">LD A,($A0BC)</td>
<td class="comment-1" rowspan="2">Increase falling speed by 2</td>
</tr>
<tr>
<td class="address-1"><span id="53645"></span>D18D</td>
<td class="instruction">ADD A,$02</td>
</tr>
<tr>
<td class="address-1"><span id="53647"></span>D18F</td>
<td class="instruction">CP $06</td>
<td class="comment-1" rowspan="2">Return if falling speed greater than 4</td>
</tr>
<tr>
<td class="address-1"><span id="53649"></span>D191</td>
<td class="instruction">RET Z</td>
</tr>
<tr>
<td class="address-1"><span id="53650"></span>D192</td>
<td class="instruction">LD ($A0BC),A</td>
<td class="comment-1" rowspan="1">Set the new falling speed</td>
</tr>
<tr>
<td class="address-1"><span id="53653"></span>D195</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="53654"></span>
<div class="comments">
<div class="paragraph">
Rex has finished falling
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="53654"></span>D196</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="2">Set falling speed to 0</td>
</tr>
<tr>
<td class="address-1"><span id="53655"></span>D197</td>
<td class="instruction">LD ($A0BC),A</td>
</tr>
<tr>
<td class="address-1"><span id="53658"></span>D19A</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="53659"></span>
<div class="comments">
<div class="paragraph">
Rex has fallen through bottom room
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="53659"></span>D19B</td>
<td class="instruction">LD A,($A08F)</td>
<td class="comment-1" rowspan="3">If no bottom room connection then jump to kill Rex</td>
</tr>
<tr>
<td class="address-1"><span id="53662"></span>D19E</td>
<td class="instruction">OR A</td>
</tr>
<tr>
<td class="address-1"><span id="53663"></span>D19F</td>
<td class="instruction">JP Z,$D1AE</td>
</tr>
<tr>
<td class="address-1"><span id="53666"></span>D1A2</td>
<td class="instruction">LD ($A0B8),A</td>
<td class="comment-1" rowspan="1">Set the new room</td>
</tr>
<tr>
<td class="address-1"><span id="53669"></span>D1A5</td>
<td class="instruction">LD A,$08</td>
<td class="comment-1" rowspan="2">Set the new y-position of Rex as 8</td>
</tr>
<tr>
<td class="address-1"><span id="53671"></span>D1A7</td>
<td class="instruction">LD ($A0B7),A</td>
</tr>
<tr>
<td class="address-1"><span id="53674"></span>D1AA</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore <span class="register">BC</span></td>
</tr>
<tr>
<td class="address-1"><span id="53675"></span>D1AB</td>
<td class="instruction">JP <a href="51546.html">$C95A</a></td>
<td class="comment-1" rowspan="1">Check for end game room</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="53678"></span>
<div class="comments">
<div class="paragraph">
No room connection, kill Rex
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="53678"></span>D1AE</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="3">Set Rex to not jumping nor falling</td>
</tr>
<tr>
<td class="address-1"><span id="53679"></span>D1AF</td>
<td class="instruction">LD ($A0BC),A</td>
</tr>
<tr>
<td class="address-1"><span id="53682"></span>D1B2</td>
<td class="instruction">LD ($A0BD),A</td>
</tr>
<tr>
<td class="address-1"><span id="53685"></span>D1B5</td>
<td class="instruction">CALL <a href="39898.html">$9BDA</a></td>
<td class="comment-1" rowspan="1">Handle Rex dead</td>
</tr>
<tr>
<td class="address-1"><span id="53688"></span>D1B8</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="53476.html">D0E4</a>
</td>
<td class="up">Up: <a href="../maps/all.html#53581">Map</a></td>
<td class="next">
Next: <a href="53689.html">D1B9</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Rex (Side A) RAM disassembly 20211106</div>
<div class="copyright">&#169; 1988 Martech Games Ltd. &#169; 2021 Andreu Font.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.5.</div>
</footer>
</body>
</html>